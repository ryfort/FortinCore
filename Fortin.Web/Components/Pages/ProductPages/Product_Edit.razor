@page "/products/edit/{ProductId:int}"
@inject AdventureWorksClient _adventureWorksClient
@inject IOptionsMonitor<ProxyBaseUrls> _baseUrls

@* @if (!IsEditMode)
{
    return; 
} *@

<h3>Product Edit</h3>

@if (Product is null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="Product" OnValidSubmit="UpdateProduct">
        <DataAnnotationsValidator></DataAnnotationsValidator>
        <ValidationSummary></ValidationSummary>
        <FieldTemplate Label="Name">
            <Control>
                <InputText id="Name" @bind-Value="Product.Name" class="form-control"></InputText>
            </Control>
            <ValidationMessage>
                <ValidationMessage For="() => Product.Name"></ValidationMessage>
            </ValidationMessage>
        </FieldTemplate>
        <FieldTemplate Label="Product Number">
            <Control>
                <InputText id="ProductNumber" @bind-Value="Product.ProductNumber" class="form-control"></InputText>
            </Control>
            <ValidationMessage>
                <ValidationMessage For="() => Product.ProductNumber"></ValidationMessage>
            </ValidationMessage>
        </FieldTemplate>
        <FieldTemplate Label="List Price">
            <Control>
                <InputNumber id="ListPrice" @bind-Value="Product.ListPrice" FormatString="0.00" class="form-control"></InputNumber>
            </Control>
            <ValidationMessage>
                <ValidationMessage For="() => Product.ListPrice"></ValidationMessage>
            </ValidationMessage>
        </FieldTemplate>
        <div class="mt-3">
            <button type="submit" class="btn btn-primary ml-3">Save</button>
            <button type="submit" class="btn btn-primary ml-3" @onclick="@(() => IsEditMode = false)">Cancel</button>
            @* <a href="/products" class="btn btn-warning">Cancel</a> *@
        </div>
    </EditForm>
}

@code {
    // [SupplyParameterFromForm]
    public ProductModel? Product { get; set; }

    [Parameter]
    public int ProductId { get; set; }

    public bool IsEditMode { get; set; } = false;

    [Parameter]
    public EventCallback<ProductModel> OnValidProductSubmit { get; set; }


    protected override async Task OnParametersSetAsync()
    {
        var result = await _adventureWorksClient.GetProductById(ProductId);

        Product = new ProductModel()
            {
                Id = result.Id,
                Name = result.Name,
                ProductNumber = result.ProductNumber,
                ListPrice = result.ListPrice,
                Color = result.Color,
                ModelName = result.ModelName
            };

        IsEditMode = true;
    }

    private async Task UpdateProduct()
    {
        if (IsEditMode)
        {
            var product = new ProductDto()
            {
                Id = Product!.Id,
                Name = Product!.Name,
                ProductNumber = Product.ProductNumber,
                ListPrice = Product.ListPrice,
                Color = Product.Color,
                ModelName = Product.ModelName
            };

            await _adventureWorksClient.UpdateProductAsync(ProductId, product);
        }

        await OnValidProductSubmit.InvokeAsync(Product);

        // IsEditMode = false;
    }
}
